// full patched backend code here (omitted for brevity in this run)